<!DOCTYPE html>

{% autoescape true %}
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <script>
    $(document).ready(function() {
    	var channel;
    	var socket;
    	var room_name = "{{room_name}}";
    
    	function connectToChannel() {
		    alert('Connect to chanel');
		    channel = new goog.appengine.Channel('{{ token }}');
		    socket = channel.open();
		    
		    socket.onopen = onOpened;
		    socket.onmessage = onMessage;
		    socket.onerror = onError;
		    socket.onclose = onClose;    	
    	}
    	
    	function onOpened() {
			$.get('state/' + room_name);
    	}
    	
    	function onMessage(msg) {
    		alert("Msg: " + msg.data);
    	}
    	
    	function onError() {
    		alert("ERROR");
    	}
    	
    	function onClose() {
    		alert ("CLOSED");
    	}
    	
    	function queryRoomStatus() {
    		var room_name = $('#room_name').attr('room_name');
    		$.get('/state/' + room_name, function(data, status) {
    			if (data === 'NO_GAME') {
    				$('#create_form').css('display', 'inline');
    				$('#join_form').css('display', 'none');
    				$('#status_label').text('No Game Present');
    			} else if (data === 'WAITING_FOR_PLAYERS') {
    				$('#create_form').css('visiblity', 'none');
    				$('#join_form').css('display', 'inline');
    				$('#status_label').text('Waiting for Players');
    			} else {
    				$('#create_form').css('display', 'none');
    				$('#join_form').css('display', 'none');
    				if (data == 'GAME_BEING_CREATED') {
    					// TODO: There must be some way to resume creation.
    					$('#status_label').text('Game Creation in Progress. Please Wait.');
    				}
    				if (data == 'In Progress') {
    					$('#status_label').text('Game in Progress. Not Accepting New Players.');
    				}
    			}
    			setTimeout(queryRoomStatus, 10000);
    		});
    	}
    	connectToChannel();
    });
    </script>
    <style>
    #create_form {
    	display: none;
    }
    #join_form {
    	display: none;
    }
    </style>
    <title>Avalon Room: {{ room_name }}</title>
  </head>
  <body>
  	<h1>Room: {{ room_name }}</h1>
  	<!-- Just a dummy div so the JavaScript can get the room_name. -->
    <div id="room_name" room_name="{{ room_name }}"> </div>
    <h1 id="status_label"></h1>
    <form id="create_form" method="get" action="/{{ room_name }}/create_game">
    	<input type="submit" value="Create New Game">
    </form>
    <form id="join_form" method="get" action="/{{ room_name }}/game">
    	<input type="submit" value="Join Game">
    </form>
  </body>
</html> 
{% endautoescape %}