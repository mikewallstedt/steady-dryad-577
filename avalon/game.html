<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Avalon: {{room_name}} Game</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script>
			$(document).ready(function() {
				function queryGameStatus() {
					var room_name = '{{ room_name }}';
			 		$.get('/' + room_name + '/game_state', function(data, status) {
						var info = $.parseJSON(data);
						$('#player_count').text('Players present = ' + info.current_number_of_players + ' out of ' + info.total_number_of_players);
						assignments = $('#assignments');
			 			assignments.empty();
						$.each(info.identities, function(index, value) {
							var contents = '<tr><td>' + value[0] + '</td><td>' + value[1] + '</td></tr>';
			 				assignments.append($(contents))
			 			});
						$('#roles_in_play').empty();
						$.each(info.all_roles, function(index, value) {
							var contents = '<li>' + value + '</li>';
							$('#roles_in_play').append($(contents));
						});
			 			
						$('#vote_on_mission_success').css('display', 'none');
						
			 			if (info.round_state === 'WAITING_FOR_TEAM_PROPOSAL') {
			 				if (info.you_are_the_leader) {
				 				$('#status_message').text('Select ' + info['team_size'][0] + ' team members');
				 				$('#create_team_proposal_buttons').empty();
				 				$.each(info.identities, function(index, value) {
				 					var contents = '<li><input type="checkbox" id="' + value[0] + '" name="' + value[0] + '"> <label for="' + value[0] + '">' + value[0] + '</label></li>'
				 					$('#create_team_proposal_buttons').append($(contents));
				 				});
				 				var submit_button = $('<input type="submit" value="Submit Team Proposal">');
				 				$('#create_team_proposal_buttons').append($('<li>').append(submit_button));
				 				$('#create_team_proposal_form').submit(function() {
				 					var number_of_boxes_checked = $('#create_team_proposal_form').find(':checkbox:checked').length;
				 					if (number_of_boxes_checked != info['team_size'][0]) {
				 						alert('Team should consist of ' + info['team_size'][0] + ' members. You chose ' + number_of_boxes_checked);
				 						return false;
				 					}
				 					return true;
				 				});
			 				} else {
			 					$('#status_message').text('Waiting for the leader to propose a team');
			 					setTimeout(queryGameStatus, 1000);
			 				}
			 			} else if (info.round_state === 'VOTING_ON_TEAM') {
			 				$('#status_message').text('');
			 				if (info.vote_needed) {
			 					$('#status_message').text('Enter your vote on this team proposal');
			 					$.each(info.team_proposal, function(index, value) {
			 						$('#team_proposal_list').append($('<li>').text(value));
			 					});
			 					$('#team_proposal_list').append($('<li>').append('<input type="radio" name="team_proposal_vote" value="yes" id="team_proposal_vote_yes"> <label for="team_proposal_vote_yes">Yes</label>'));
			 					$('#team_proposal_list').append($('<li>').append('<input type="radio" name="team_proposal_vote" value="no" id="team_proposal_vote_no"> <label for="team_proposal_vote_no">No</label>'));
			 					$('#team_proposal_list').append($('<li>').append($('<input type="submit" value="Vote">')));
			 				} else {
			 					$('#status_message').text('Waiting for other votes on team proposal');
			 					setTimeout(queryGameStatus, 1000);
			 				}
			 			} else if (info.round_state === 'MISSION_IN_PROGRESS') {
			 				if (info.in_team) {
			 					$('#status_message').text('Vote on whether the mission should succeed');
			 					$('#vote_on_mission_success').css('display', 'inline');
			 				} else {
			 					$('#status_message').text('Waiting for team members to vote on mission success');
			 					setTimeout(queryGameStatus, 1000);
			 				}
			 			} else {
			 				setTimeout(queryGameStatus, 1000);
			 			}
			 		});	
				}
				//queryGameStatus();
			});
		</script>
	</head>
	
	<body>
		<h1>Your role is {{role}}</h1>
		
		<h2>All Roles in Play</h2>
		<ul>
			{% for role in all_roles %}
  				<li>{{ role }}</li>
			{% endfor %}
		</ul>
		
		<table>
			<thead>
			<tr>
			<th>Player</th>
			<th>Role</th>
			</tr>
			</thead>
			<tbody>
				{% for identity in identities %}
  					<tr><td>{{ identity[0] }}</td><td>{{ identity[1] }}</td></tr>
				{% endfor %}
			</tbody>
		</table>
		
		<h2 id="status_message"></h2>
		
		<div id="create_team_proposal">
			<form method="post" action="/{{ room_name }}/submit_team_proposal" id="create_team_proposal_form">
				<ul id="create_team_proposal_buttons">
					<!-- JavaScript will put names in here with check boxes. -->
				</ul>
			</form>
		</div>
		
		<div id="vote_on_team_proposal">
			<form method="post" action="/{{ room_name }}/vote_on_team_proposal" id="vote_on_team_proposal_form">
				<ul id="team_proposal_list">
					<!-- JavaScript will put the proposed names here. -->
				</ul>
			</form>
		</div>
		
		<div id="vote_on_mission_success">
			<form method="post" action="/{{ room_name }}/vote_on_mission_success">
				<ul>
					<li><input type="radio" name="mission_success" id="mission_success_fail" value="failure"> <label for="mission_success_fail">Fail</label></li>
					<li><input type="radio" name="mission_success" id="mission_success_succeed" value="success"> <label for="mission_success_succeed">Succeed</label></li>
					<li><input type="submit" value="Submit">
				</ul>
			</form>
		</div>
		
		<form method="post" action="/{{ room_name }}/destroy_game" onsubmit="return confirm('Are you sure you want to destroy the game?')">
			<input type="submit" value="Destroy Game">
		</form>
	</body>
</html>